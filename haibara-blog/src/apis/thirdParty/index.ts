import http from "@/utils/http.ts";
import EasyTyper from "easy-typer-js";
// 第三方的api接口
// 一言接口
let myYiYan = import.meta.env.VITE_YIYAN_API
if (!myYiYan) {
    // 使用和后台管理端相同的分类参数：诗词(i) + 哲学(k) + 日记(d)
    myYiYan = 'https://v1.hitokoto.cn/?c=i&c=k&c=d&encode=json'
}
// 每日鸡汤 - 使用原生fetch，和后台管理端保持一致
export const getSoup = () => {
    return new Promise((resolve, reject) => {
        // 设置5秒超时
        const timeoutId = setTimeout(() => {
            reject(new Error('请求超时'))
        }, 5000)

        fetch(myYiYan)
            .then(response => {
                clearTimeout(timeoutId)
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`)
                }
                return response.json()
            })
            .then(data => {
                resolve(data)
            })
            .catch(err => {
                clearTimeout(timeoutId)
                reject(err)
            })
    })
}

// 本地备用鸡汤库 - 防止API失败时打字机卡住
const localTypingSoups = [
    "今天的努力，是为了明天更好的自己。",
    "成功不是终点，失败不是末日，继续前进的勇气才是最重要的。",
    "代码如诗，每一行都承载着创造的力量。",
    "山重水复疑无路，柳暗花明又一村。",
    "路漫漫其修远兮，吾将上下而求索。",
    "宝剑锋从磨砺出，梅花香自苦寒来。",
    "千里之行，始于足下。",
    "不积跬步，无以至千里；不积小流，无以成江海。",
    "业精于勤，荒于嬉；行成于思，毁于随。",
    "天行健，君子以自强不息。",
    "落红不是无情物，化作春泥更护花。",
    "海纳百川，有容乃大；壁立千仞，无欲则刚。",
    "博观而约取，厚积而薄发。",
    "纸上得来终觉浅，绝知此事要躬行。",
    "山不在高，有仙则名；水不在深，有龙则灵。",
    "今天的努力，是为了明天更好的自己。",
    "重要的不是你现在的位置，而是你前进的方向。",
    "即使道路泥泞，也要勇往直前。",
    "我要成为海贼王！",
    "恐惧并不可怕，可怕的是被恐惧控制。",
    "真正的强者，是能够保护他人微笑的人。",
    "希望是附丽于存在的，有存在，便有希望。",
    "即使再渺小的光，也能照亮黑暗。",
    "要么旅行，要么读书，身体和灵魂总有一个要在路上。",
    "胜利属于最坚韧的人。",
    "人总要相信些什么，哪怕是星辰大海。",
    "别为打翻的牛奶哭泣。",
    "不要轻易放弃，否则对不起自己。",
    "世界并不完美，但正因如此才值得我们去改变。",
    "痛苦无法避免，但可以选择以何种态度面对。",
    "活着就意味着战斗。",
    "我们不能决定太阳何时升起，但可以决定自己几点起床。",
    "真正重要的东西，总是无形的。",
    "人生就是不断战斗与妥协的过程。",
    "当你凝视深渊时，深渊也在凝视你。",
    "梦不会逃跑，逃跑的只有自己。",
    "吾辈当自强。",
    "愿你以梦为马，不负韶华。",
    "以剑为誓，以心为盾。",
    "你所热爱的事情，终将成就你。",
    "胜者为王，败者为寇。",
    "不要为旧的悲伤浪费新的眼泪。",
    "我们都是夜晚行走的旅人。",
    "你拼尽全力的样子，真的很美。",
    "命运给予我们刺痛，但也隐藏了礼物。",
    "成功不是将来才有的，而是从你决定去做的那一刻起，持续累积而成。",
    "当你感到疲惫的时候，说明你正在走上坡路。",
    "没有人能回到过去重新开始，但每个人都可以从现在开始创造全新的结局。",
    "越是试图忘记，越是记得深刻。",
    "真正的勇气不是无所畏惧，而是心怀恐惧仍然前行。",
    "命运如同手中的掌纹，无论多曲折，终掌握在自己手中。",
    "不要轻言放弃，否则对不起你坚持了那么久的自己。",
    "世界那么大，我想去看看。",
    "你之所以觉得时间快，是因为你做的事情不值得记住。",
    "人的一生要疯狂一次，无论是为一个人、一段情、一个梦想。",
    "不积跬步，无以至千里；不积小流，无以成江海。",
    "为了未来美一点，现在必须苦一点。",
    "心之所向，素履以往。生如逆旅，一苇以航。",
    "吾日三省吾身。",
    "不要害怕结束，它只是另一种开始。",
    "只要你足够坚强，命运就无法击垮你。",
    "别让梦想只是梦想。",
    "即使失败了，也要帅气地倒下。",
    "人不是因为成长才学会放弃，而是因为放弃才长大。",
    "即使世界背弃了你，我也不会。",
    "即使没有希望，也要拼尽全力去争取希望。",
    "有些事情不是看到希望才坚持，而是坚持了才会有希望。",
    "命运是弱者的借口，是强者的座右铭。",
    "真正的勇士，是敢于直面惨淡人生的。",
    "你永远无法叫醒一个装睡的人。",
    "总有一天，你会站在最亮的地方，活成你曾经渴望的模样。",
    "没有什么比信仰更能支撑一个人前行。",
    "痛苦不会毁掉你，躲避痛苦才会。",
    "有光的地方就有影子。",
    "我们生来并不是为了被打败的。",
    "人生的价值不在于你活了多久，而在于你活得多精彩。",
    "这世界本没有什么救世主，能够拯救你的只有你自己。",
    "就算希望只剩下1%，也要拼尽100%的努力。",
    "有些路，只能一个人走。",
    "你要相信，一切都会变好的，哪怕不是现在。",
    "你喜欢的样子我都有，你害怕的事情我都能替你挡。",
    "没有人规定你必须坚强到让人心疼。",
    "有些梦想虽然遥远，但从不曾放弃。",
    "人在被给予理解之前，是孤独的。",
    "我的人生不需要过多解释，懂我的人自然懂。",
    "不管多辛苦，也别放弃你曾渴望的东西。",
    "真正的自由，是内心的安定。",
    "如果命运是一条孤独的河，那我就是逆流而上的鱼。",
    "一个人并不是生来要被打败的。",
    "星星之火，可以燎原。",
    "每一次重生，都是因为未完成的热爱。",
    "你的过去我不曾参与，但你的未来我不会缺席。",
    "孤独不是没人爱你，而是你想爱的人不在身边。",
    "当你在凝视深渊时，深渊也在凝视你。",
    "真正重要的东西，不靠眼睛，而是用心去感受。",
    "路在脚下，无论多远也终会抵达。",
    "我不怕千万人阻挡，只怕自己投降。",
    "凡是过往，皆为序章。",
    "真正的绝望不是哭喊，而是沉默。",
    "你可以一无所有，但绝不能没有梦想。",
    "勇气是明知道会失败，也依然选择去做。",
    "人生如棋，落子无悔。",
    "不要让世界改变你，而是你去改变世界。",
    "人生就像一场RPG，主角不一定一开始就无敌。",
    "若结局非你所愿，就在尘埃落定前奋力一搏。",
    "就算是深渊，我也会笑着跳下去。",
    "无论你走得多远，别忘了为何出发。",
    "英雄，就是普通人拥有一颗不屈的心。",
    "别怕你的梦想太大，笑你的人才可笑。",
    "风会带着希望，从远方吹来。",
    "只有不想做的，没有做不到的。",
    "你走得慢没关系，只要你从不后退。",
    "愿你出走半生，归来仍是少年。"


];

// 获取随机本地鸡汤
const getRandomLocalSoup = () => {
    const randomIndex = Math.floor(Math.random() * localTypingSoups.length);
    return localTypingSoups[randomIndex];
};

// 打字机-每日鸡汤（带错误处理和重试机制）
export const getSoupTyping = (obj: any, retryCount = 0) => {
    // 设置5秒超时
    const timeoutId = setTimeout(() => {
        console.log('API请求超时，使用本地内容');
        const localSoup = getRandomLocalSoup();
        startTyping(obj, localSoup);
    }, 5000);

    fetch(myYiYan)
        .then((res) => {
            clearTimeout(timeoutId);
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then((data) => {
            const hitokoto = data.hitokoto;
            // 验证数据有效性
            if (!hitokoto || hitokoto.trim() === '') {
                throw new Error('返回的内容为空');
            }
            startTyping(obj, hitokoto);
        })
        .catch((error) => {
            clearTimeout(timeoutId);
            console.log('API获取失败:', error.message);

            // 重试机制：最多重试2次
            if (retryCount < 2) {
                console.log(`第${retryCount + 1}次重试...`);
                setTimeout(() => {
                    getSoupTyping(obj, retryCount + 1);
                }, 1000); // 1秒后重试
            } else {
                console.log('重试次数用完，使用本地内容');
                const localSoup = getRandomLocalSoup();
                startTyping(obj, localSoup);
            }
        });
};

// 启动打字机的统一函数
const startTyping = (obj: any, text: string) => {
    new EasyTyper(
        obj,
        text,
        () => {
            // 完成回调：延迟一下再开始下一轮，避免过于频繁的请求
            setTimeout(() => {
                getSoupTyping(obj, 0); // 重置重试计数
            }, 500);
        },
        () => {
            // 进度回调
        }
    );
};
